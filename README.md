# 프로젝트 설계서: unreal-blender-mcp

## 1. 프로젝트 개요

- **목표:**
Claude나 ChatGPT와 같은 AI 에이전트를 통해 MCP 서버와 연동하여, 언리얼과 블렌더를 원격에서 컨트롤할 수 있도록 지원합니다.
- **주요 산출물:**
    1. 언리얼 플러그인
    2. 블렌더 애드온/플러그인
    3. MCP 서버
- **개발 언어:**
모든 컴포넌트는 Python으로 개발됩니다.
- **핵심 원칙:**
    - AI가 각 플랫폼(언리얼, 블렌더)을 효과적으로 활용할 수 있도록 명확한 API와 함수 정의.
    - 안전한 코드 실행 및 예외 처리를 통한 안정성 보장.
    - 각 모듈이 독립적으로 동작하면서도 MCP 서버를 통해 통합 통신을 수행.

---

## 2. 시스템 아키텍처 개요

- **중심 모듈:** MCP 서버
    - SSE(Server-Sent Events) 기반으로 AI 에이전트와 실시간 통신.
    - Langchain 라이브러리를 활용하여 블렌더의 상태 저장, 문서 활용 및 장기 기억 기능 제공.
- **엣지 모듈:** 언리얼 플러그인과 블렌더 애드온
    - 각각 포트 8500(언리얼)과 8400(블렌더)에서 POST 요청을 받아 Python 코드를 실행.
    - 실행 결과와 예외를 명확하게 리턴하며, 시스템 크래쉬를 방지하는 방어 코드를 내장.

**통신 흐름 요약:**

1. AI 에이전트는 MCP 서버에 명령 및 실행할 코드 요청 전송.
2. MCP 서버는 요청을 분석한 후, 해당 명령을 언리얼 플러그인 또는 블렌더 애드온에 전달하는 함수 호출을 진행.
3. 각 플러그인은 POST 요청을 통해 전달된 코드를 안전하게 실행하고 결과 및 오류 정보를 MCP 서버에 전달.
4. MCP 서버는 Langchain을 활용하여 상태 관리 및 작업 히스토리를 갱신하고, AI 에이전트에 결과를 반환.

---

## 3. 구성 요소 상세 설계

### 3.1. 언리얼 플러그인

- **기능 및 역할:**
    - 외부(주로 MCP 서버)로부터 POST 방식으로 전달된 Python 코드를 실행.
    - 실행 결과와 발생한 예외를 명확히 리턴.
    - 시스템 크래쉬를 방지하는 안전장치 및 방어 코드를 구현.
- **포트:** 8500
- **개발 언어 및 프레임워크:**
    - Python (Flask, FastAPI 등 HTTP 서버 프레임워크 활용)
- **주요 기능:**
    - `/execute` 엔드포인트:
        - 요청 데이터로 실행할 Python 코드 수신.
        - 안전한 코드 실행 (try-except, sandbox 또는 제한된 실행 환경 고려).
        - 실행 결과와 오류 메시지 기록 및 반환.
- **안정성 및 예외 처리:**
    - 코드 실행 전 입력값 검증.
    - 실행 중 발생하는 모든 예외를 캡쳐하여 로그 및 응답 메시지에 포함.
    - 크래쉬 방지를 위한 타임아웃 및 리소스 제한 설정.

### 3.2. 블렌더 애드온/플러그인

- **기능 및 역할:**
    - Blender 환경 내에서 동작하며, MCP 서버로부터 POST 방식으로 전달된 Python 코드를 실행.
    - 실행 결과와 오류 메시지를 UI 혹은 로그를 통해 명확히 제공.
    - Blender 내 안정성을 보장하기 위한 방어 코드 적용.
- **포트:** 8400
- **개발 언어 및 API:**
    - Python (Blender의 내장 Python API 활용)
- **주요 기능:**
    - `/execute` 엔드포인트 구현:
        - 실행할 Python 코드를 POST 방식으로 수신.
        - 안전하게 코드를 실행하며, Blender의 상태나 작업환경에 영향을 최소화.
        - 결과 및 오류를 포맷팅하여 반환.
- **안정성 및 예외 처리:**
    - Blender 환경과의 충돌을 방지하기 위해 별도 스레드나 비동기 처리 고려.
    - 실행 전후 상태 롤백이나 안전장치 적용.
    - 에러 발생 시, 상세한 에러 로그와 함께 사용자에게 알림.

### 3.3. MCP 서버

- **기능 및 역할:**
    - AI 에이전트와 실시간 통신을 위한 SSE 서버 구현.
    - 언리얼 플러그인과 블렌더 애드온에 호출할 함수들을 미리 정의하여, AI가 수행할 작업을 명확하게 지정.
    - Langchain 라이브러리를 활용하여 블렌더 상태 관리, 문서 전처리 및 장기 기억 기능 제공.
- **포트:** 8300
- **개발 언어 및 프레임워크:**
    - Python (Flask, FastAPI 및 SSE 지원 라이브러리 사용)
- **주요 기능:**
    - **SSE 통신:**
        - `/stream` 엔드포인트를 통해 AI 에이전트와 실시간 메시지 주고받기.
    - **명령어/함수 정의:**
        - `execute_unreal_command(command: str, parameters: dict)`
        - `execute_blender_command(command: str, parameters: dict)`
        - 각 함수는 명확하게 정의된 인터페이스를 통해 안전한 명령 실행 보장.
    - **Langchain 통합:**
        - 작업 히스토리 저장, 문서 분석, 장기 기억 기능.
        - 사용자 정의 프롬프트를 커스터마이징할 수 있는 인터페이스 제공.
- **안정성 및 예외 처리:**
    - 각 호출 함수에 대해 입력값 검증 및 예외 처리 구현.
    - Langchain 관련 동작에서 발생하는 오류를 캡쳐하여 로그 및 재시도 로직 적용.
    - 네트워크 통신 오류 및 SSE 연결 유지에 대한 재연결 로직 적용.

---

## 4. API 및 인터페이스 정의

### 4.1. 언리얼 플러그인 API (포트 8500)

- **Endpoint:** `/execute`
- **HTTP Method:** POST
- **Request Body 예시:**
    
    ```json
    json
    복사
    {
      "code": "print('Hello Unreal')"
    }
    
    ```
    
- **Response 예시:**
    
    ```json
    json
    복사
    {
      "result": "Hello Unreal",
      "error": null}
    
    ```
    
- **주요 고려사항:**
    - 입력 코드의 유효성 검사 및 샌드박스 환경에서의 실행.
    - 실행 시간 제한 및 리소스 소비 제한 적용.

### 4.2. 블렌더 애드온 API (포트 8400)

- **Endpoint:** `/execute`
- **HTTP Method:** POST
- **Request Body 예시:**
    
    ```json
    json
    복사
    {
      "code": "bpy.ops.mesh.primitive_cube_add()"
    }
    
    ```
    
- **Response 예시:**
    
    ```json
    json
    복사
    {
      "result": "Cube 생성 완료",
      "error": null}
    
    ```
    
- **주요 고려사항:**
    - Blender 내부 상태와의 상호작용 시 충돌 방지.
    - UI에 결과 표시하거나, 로그 파일에 기록하는 방법 구현.

### 4.3. MCP 서버 API (포트 8300)

- **SSE Endpoint:** `/stream`
    - AI 에이전트와의 실시간 메시지 송수신.
- **내부 함수 인터페이스:**
    - **언리얼 호출:**
        - `execute_unreal_command(command: str, parameters: dict)`
            - 명령어에 따른 언리얼 플러그인 호출.
    - **블렌더 호출:**
        - `execute_blender_command(command: str, parameters: dict)`
            - 명령어에 따른 블렌더 애드온 호출.
- **Langchain 관련 인터페이스:**
    - 문서 전처리, 메모리 저장 및 검색 함수.
    - 사용자 정의 프롬프트 커스터마이징 기능.

---

## 5. 데이터 흐름 및 통신 구조

1. **AI 에이전트 → MCP 서버:**
    - 에이전트가 특정 작업(예: “Unreal에서 특정 이벤트 실행”)에 대한 명령을 SSE 채널을 통해 전송.
2. **MCP 서버 내부 처리:**
    - 명령어 파싱 후, 해당 작업을 수행하기 위해 정의된 호출 함수 실행.
    - Langchain을 통해 필요한 문서나 메모리 정보를 조회하여, 작업 정확도 향상.
3. **MCP 서버 → 언리얼/블렌더 플러그인:**
    - 각 플러그인에 POST 요청으로 Python 코드 전달.
4. **언리얼/블렌더 플러그인 → MCP 서버:**
    - 코드 실행 결과 또는 에러 메시지를 반환.
5. **MCP 서버 → AI 에이전트:**
    - 최종 실행 결과 및 상태 정보를 SSE를 통해 전송.

---

## 6. 개발 환경 및 의존성

- **Python 버전:** 3.x
- **웹 프레임워크:** Flask 또는 FastAPI (각 모듈에 적합한 선택)
- **SSE 지원:** Flask-SSE 또는 sse-starlette 등
- **Langchain:** 문서 처리 및 메모리 기능 구현을 위한 라이브러리
- **Blender 및 Unreal 관련 API:**
    - Blender: 내장 Python API (bpy 모듈)
    - Unreal: Python 플러그인 개발 가이드 참조
- **추가 라이브러리:** Logging, Exception Handling, Sandbox/보안 관련 모듈

---

## 7. 테스트 및 배포 전략

- **단위 테스트:**
    - 각 모듈의 기능별로 단위 테스트 작성 (예: API 응답, 예외 처리)
- **통합 테스트:**
    - MCP 서버와 플러그인 간의 실제 통신 시나리오 테스트
- **시나리오 테스트:**
    - AI 에이전트와의 전체 흐름을 검증하는 End-to-End 테스트
- **배포 전략:**
    - Docker 컨테이너를 활용하여 각 모듈의 독립적 배포
    - CI/CD 파이프라인 구축으로 자동 테스트 및 배포

---

## 8. 보안 및 안정성 강화 방안

- **안전한 코드 실행:**
    - 입력 코드에 대한 샌드박스 실행 환경 제공 (제한된 네임스페이스, 타임아웃 설정)
- **예외 처리 및 로깅:**
    - 모든 함수와 API에서 try-except 블록 적용 및 상세 로그 기록
- **네트워크 보안:**
    - 필요 시 SSL/TLS 암호화 적용
- **리소스 관리:**
    - 코드 실행 시 메모리 및 CPU 사용량 제한, 무한 루프 방지 로직 적용

---

## 9. 향후 확장 및 유지보수

- **확장성:**
    - 새로운 명령어 및 기능 추가 시, MCP 서버의 함수 및 API 확장
    - 모듈 간 인터페이스 문서화를 통해 향후 유지보수 용이성 확보
- **업데이트:**
    - Langchain 프롬프트 및 메모리 관리 로직 개선, AI 에이전트 피드백 반영
- **모니터링:**
    - 각 모듈별 상태 모니터링 및 에러 리포팅 시스템 구축

---

## 결론

이 설계서는 AI 에이전트가 언리얼과 블렌더를 효과적으로 컨트롤할 수 있도록 하기 위한 명확한 구조와 인터페이스를 제공합니다. 각 컴포넌트는 독립적으로 동작하면서도 MCP 서버를 통해 통합되어 안정적인 시스템을 구축하며, Langchain의 장기 기억 및 문서 활용 기능을 통해 작업의 정확성과 효율성을 극대화합니다.

이 설계서를 기반으로 에이전트 AI가 실제 코드를 작성할 때, 각 모듈의 역할과 통신 방식, 예외 처리 및 보안 요구사항을 충실히 반영하여 개발을 진행할 수 있을 것입니다.